version: 1.0.{build}

image: Visual Studio 2019

skip_branch_with_pr: true
branches:
  only:
    - master
    - dev
    - /release\/.*/

cache:
- node_modules -> **\package.json

install:
- ps: $IsMasterBranch = ($env:APPVEYOR_REPO_BRANCH -eq "master" -And -not $env:APPVEYOR_PULL_REQUEST_NUMBER)
- ps: $fileContent = "-----BEGIN RSA PRIVATE KEY-----`n"
- ps: $fileContent += $env:priv_key.Replace(' ', "`n")
- ps: $fileContent += "`n-----END RSA PRIVATE KEY-----`n"
- ps: Set-Content c:\users\appveyor\.ssh\id_rsa $fileContent
- ps: Install-Product node 'LTS'
- git submodule -q update --init --recursive

build_script:
- dotnet build -c Release LETS.Web\LETS.Web.csproj

test_script:
- dotnet test -c Release OrchardCore.LETS\Tests\LETS.Tests.csproj
- cd .\OrchardCore.LETS\Tests\Functional
- npm install
- npm run test
- cd .\

deploy_script:
- ps: |
    if ($IsMasterBranch)
    {
      cd $env:APPVEYOR_BUILD_FOLDER
      dir
      docker build -t $env:DOCKER_USER/letsweb:latest -f $env:APPVEYOR_BUILD_FOLDER\LETS.Web\Dockerfile . 2>&1 | %{ "$_" }
      echo "$env:DOCKER_PASS" | docker login -u="$env:DOCKER_USER" --password-stdin
      docker push $env:DOCKER_USER/letsweb:latest
    }